# Makefile.test - ãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»ãƒ†ã‚¹ãƒˆDBç®¡ç†

.PHONY: test test-only test-coverage test-coverage-report test-coverage-html test-color-setup install-gotestsum test-setup test-db-up test-db-status test-db-down test-swagger

test-setup:
	@echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."
	@./script/gen-test-env.sh
	@echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨DBã‚’èµ·å‹•ä¸­..."
	@docker compose -f docker/docker-compose.test.yml up -d db-test
	@echo "â³ DBèµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
	@sleep 10
	@echo "âœ… ãƒ†ã‚¹ãƒˆç”¨DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

test:
	@echo "ğŸ§ª Docker DBã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™..."; \
		$(MAKE) test-setup; \
	fi
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@cd src && if PATH="$(PATH):$(HOME)/go/bin" command -v gotestsum > /dev/null; then \
		GIN_MODE=test FORCE_COLOR=1 PATH="$(PATH):$(HOME)/go/bin" gotestsum --format=standard-verbose -- ./test/... -timeout 60s; \
	else \
		GIN_MODE=test GOTESTSUM_FORMAT=standard-verbose FORCE_COLOR=1 go test -v ./test/... -timeout 60s; \
	fi

test-only:
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œä¸­ï¼ˆDBã®èµ·å‹•ãƒ»åœæ­¢ãªã—ï¼‰..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && if PATH="$(PATH):$(HOME)/go/bin" command -v gotestsum > /dev/null; then \
		GIN_MODE=test FORCE_COLOR=1 PATH="$(PATH):$(HOME)/go/bin" gotestsum --format=standard-verbose -- ./test/... -timeout 60s; \
	else \
		GIN_MODE=test GOTESTSUM_FORMAT=standard-verbose FORCE_COLOR=1 go test -v ./test/... -timeout 60s; \
	fi

test-color-setup:
	@echo "ğŸ¨ ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã¾ã™..."
	@export FORCE_COLOR=1
	@export GOTESTSUM_FORMAT=standard-verbose
	@export GOFLAGS="-test.v"
	@echo "âœ… ã‚«ãƒ©ãƒ¼å‡ºåŠ›ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ"

define show_total_coverage
	@echo "ğŸ¯ å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡:"
	@cd src && TOTAL_COVERAGE=$$(go tool cover -func=../coverage.out | grep "total:" | awk '{print $$3}' | sed 's/%//'); \
	echo "ğŸ“Š å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸: $$TOTAL_COVERAGE%"; \
	echo ""; \
	echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"; \
	echo "â”‚                ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼           â”‚"; \
	echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"; \
	if [ $$(echo "$$TOTAL_COVERAGE >= 90" | bc) -eq 1 ]; then \
		echo "â”‚  ğŸŸ¢ å„ªç§€ãªã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã§ã™ï¼ ($$TOTAL_COVERAGE%)           â”‚"; \
		echo "â”‚     ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ªã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆï¼         â”‚"; \
	elif [ $$(echo "$$TOTAL_COVERAGE >= 80" | bc) -eq 1 ]; then \
		echo "â”‚  ğŸŸ¡ è‰¯å¥½ãªã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã§ã™ ($$TOTAL_COVERAGE%)             â”‚"; \
		echo "â”‚     ã•ã‚‰ãªã‚‹æ”¹å–„ã§å„ªç§€ãƒ¬ãƒ™ãƒ«ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼           â”‚"; \
	elif [ $$(echo "$$TOTAL_COVERAGE >= 70" | bc) -eq 1 ]; then \
		echo "â”‚  ğŸŸ  æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ ($$TOTAL_COVERAGE%)               â”‚"; \
		echo "â”‚     é‡è¦ãªæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„                 â”‚"; \
	else \
		echo "â”‚  ğŸ”´ ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ãŒä½ã™ãã¾ã™ ($$TOTAL_COVERAGE%)           â”‚"; \
		echo "â”‚     ãƒ†ã‚¹ãƒˆã‚’å¤§å¹…ã«è¿½åŠ ã—ã¦ãã ã•ã„                       â”‚"; \
	fi; \
	echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"; \
	echo ""
endef

test-coverage:
	@echo "ğŸ§ª ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && echo "ğŸ’¡ WSLç’°å¢ƒã§ã¯gotestsumã®ã‚«ãƒ©ãƒ¼å‡ºåŠ›ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™"; \
	GIN_MODE=test GOFLAGS="-test.v" GOTESTSUM_FORMAT=standard-verbose FORCE_COLOR=1 go test -v -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s | sed 's/^PASS$$/âœ… PASS/; s/^FAIL$$/âŒ FAIL/; s/^RUN$$/ğŸƒ RUN/; s/^--- PASS: /âœ… PASS: /; s/^--- FAIL: /âŒ FAIL: /; s/^coverage: \([0-9.]*\)% of statements/ğŸ“Š coverage: \1% of statements/; s/^=== RUN/ğŸƒ === RUN/; s/^DONE \([0-9]*\) tests in \([0-9.]*s\)/ğŸ‰ DONE \1 tests in \2s/'
	@echo ""
	$(show_total_coverage)
	@echo ""
	@echo "ğŸ“Š ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸:"
	@cd src && go tool cover -func=../coverage.out | grep -E "(services|models|handler|middleware|router|config|utils)" | sed 's/backend\//ğŸ“¦ /' | sed 's/\.go:/: /' | sed 's/(statements)/ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ/'

test-coverage-report:
	@echo "ğŸ§ª ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && if PATH="$(PATH):$(HOME)/go/bin" command -v gotestsum > /dev/null; then \
		GIN_MODE=test FORCE_COLOR=1 PATH="$(PATH):$(HOME)/go/bin" gotestsum --format=standard-verbose -- -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s; \
	else \
		GIN_MODE=test GOTESTSUM_FORMAT=standard-verbose FORCE_COLOR=1 go test -v -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s; \
	fi
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: coverage.out"
	@echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°ã‚’è¡¨ç¤º:"
	@cd src && go tool cover -func=../coverage.out

test-coverage-html:
	@echo "ğŸ§ª HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && if PATH="$(PATH):$(HOME)/go/bin" command -v gotestsum > /dev/null; then \
		GIN_MODE=test FORCE_COLOR=1 PATH="$(PATH):$(HOME)/go/bin" gotestsum --format=standard-verbose -- -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s; \
	else \
		GIN_MODE=test GOTESTSUM_FORMAT=standard-verbose FORCE_COLOR=1 go test -v -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s; \
	fi
	@echo "ğŸ“Š HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
	@cd src && go tool cover -html=../coverage.out -o ../coverage.html
	@echo "âœ… HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: coverage.html"
	@echo "ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã: open coverage.html ã¾ãŸã¯ coverage.html ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯"

install-gotestsum:
	@echo "ğŸ“¦ gotestsumã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	@if ! command -v gotestsum > /dev/null; then \
		go install gotest.tools/gotestsum@latest; \
		echo "âœ… gotestsumã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"; \
	else \
		echo "âœ… gotestsumã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿"; \
	fi
	@echo "ğŸ”§ PATHã«~/go/binã‚’è¿½åŠ ä¸­..."
	@if ! grep -q "export PATH=\$PATH:\$HOME/go/bin" ~/.bashrc; then \
		echo 'export PATH=$PATH:$HOME/go/bin' >> ~/.bashrc; \
		echo "âœ… PATHè¨­å®šã‚’~/.bashrcã«è¿½åŠ ã—ã¾ã—ãŸ"; \
		echo "ğŸ”„ æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã‹ã€source ~/.bashrc ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	else \
		echo "âœ… PATHè¨­å®šã¯æ—¢ã«~/.bashrcã«å«ã¾ã‚Œã¦ã„ã¾ã™"; \
	fi
	@echo "ğŸ¨ ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
	@echo "   export FORCE_COLOR=1"
	@echo "   export GOTESTSUM_FORMAT=standard-verbose"

test-swagger:
	@echo "ğŸ§ª Swaggerãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@cd src && if PATH="$(PATH):$(HOME)/go/bin" command -v gotestsum > /dev/null; then \
		GIN_MODE=test FORCE_COLOR=1 PATH="$(PATH):$(HOME)/go/bin" gotestsum --format=standard-verbose -- ./test/... -run "TestSwagger"; \
	else \
		GIN_MODE=test GOTESTSUM_FORMAT=standard-verbose FORCE_COLOR=1 go test -v ./test/... -run "TestSwagger"; \
	fi

test-db-up:
	@echo "ğŸ³ ãƒ†ã‚¹ãƒˆç”¨DBã‚’èµ·å‹•ä¸­..."
	docker compose -f docker/docker-compose.test.yml up -d db-test

test-db-status:
	@echo "ğŸ” ãƒ†ã‚¹ãƒˆç”¨DBã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
	@docker compose -f docker/docker-compose.test.yml ps db-test

test-db-down:
	@echo "ğŸ³ ãƒ†ã‚¹ãƒˆç”¨DBã‚’åœæ­¢ä¸­..."
	docker compose -f docker/docker-compose.test.yml down 